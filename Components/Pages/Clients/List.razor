@page "/Clients/List"
@page "/Clients/List/{ClientId:int}"

@using Newtonsoft.Json
@using Newtonsoft.Json.Linq
@using Mantis.Domain.Clients.Models
@using Mantis.Domain.Clients.Services
@using Mantis.Domain.Policies.Models
@using Mantis.Domain.Renewals.Models
@using Mantis.Components.Shared
@using Microsoft.FluentUI.AspNetCore.Components
@using Syncfusion.Blazor
@using Syncfusion.Blazor.Inputs
@using Syncfusion.Blazor.Lists
@using Mantis.Data
@using Mantis.Domain.Renewals.Services
@inject HttpClient Http
@inject NavigationManager NavigationManager
@inject NavigationService NavigationService
@inject RenewalService RenewalService
@inject CrmApiService CrmApiService
@inject ClientService ClientService
@inject IJSRuntime jsRuntime
@rendermode InteractiveServer

@if (selectedClient != null)
{
    <_toolbar ClientId="selectedClient.ClientId" />
}

<div class="page-content">
    <div style="display:flex; flex-direction:row;">
        <div class="@dynamicClass">
            <FluentTextField @bind-Value="searchTerm" @oninput="OnInputChanged" Placeholder="Search for a client..." Class="sf-searchquick">
                <FluentIcon Value="@(new Icons.Regular.Size16.Search())" Slot="start" Color="Color.Neutral" />
            </FluentTextField>
            <SfListView TItem="Client" DataSource="filteredClients" CssClass="client-list">
                <ListViewFieldSettings TValue="Client" Id="ClientId" Text="Name" />
                <ListViewEvents TValue="Client" Clicked="@ClickHandler" />
            </SfListView>
        </div>
    </div>

    @if (selectedClient != null)
    {
        <div class="sf-selected" style="position:relative;">
            <div class="tinyexpander" @onclick="ExpandDetails"><img src="/img/tinyexpand.png" /></div>
            <div class="sf-header">
                <div class="client-header">
                    @selectedClient.Name <br />
                    <span class="client-address">
                        @selectedClient.Address.AddressLine1 @selectedClient.Address.AddressLine2 @selectedClient.Address.City, @selectedClient.Address.State @selectedClient.Address.PostalCode
                    </span>
                </div>

                <div class="client-header-2">
                </div>

                <div class="client-header-3">
                    <span class="client-phone">@selectedClient.PhoneNumber</span><br />
                    <span class="client-email">@selectedClient.Email</span>
                </div>
            </div>

            <div class="sf-col-container">
                <div class="sf-col sf-col-1">
                    <h3>Current Policies</h3>
                    <SfSpinner @bind-Visible="@isLoadingCrmId"></SfSpinner>
                    <div class="policy-container">
                        @foreach (var policy in currentPolicies)
                        {
                            <div class="policy">
                                <div class="policy-header">
                                    <div>@policy.eType <span style="font-size:7px;">@policy.PolicyId</span></div>
                                    <div>@policy.EffectiveDate.ToShortDateString() - @policy.ExpirationDate.ToShortDateString()</div>
                                </div>
                                <div class="policy-details">
                                    <div>@policy.Carrier?.CarrierName / @policy.Wholesaler?.CarrierName</div>
                                </div>
                                <div class="policy-details">
                                    <div>@policy.PolicyNumber</div>
                                    <div>@policy.Premium.ToString("C")</div>
                                </div>
                            </div>
                            <FluentButton OnClick="@((e) => EditPolicy(policy.PolicyId))">Edit Policy</FluentButton> <FluentButton OnClick="@((e) => CreateRenewal(policy.PolicyId))">Create Renewal</FluentButton>
                        }
                        <h4>Past Policies</h4>
                        <SfSpinner @bind-Visible="@isLoadingCrmId"></SfSpinner>
                        @foreach (var policy in pastPolicies)
                        {
                            <div class="past-policy">
                                <div class="sf-pp">@policy.eType</div>
                                <div>@policy.PolicyNumber</div>
                                <div>@policy.Carrier?.LookupCode</div>
                                <div>@policy.Wholesaler?.LookupCode</div>
                                <div class="sf-da">@policy.EffectiveDate.ToShortDateString()</div>
                                <div class="sf-da">@policy.ExpirationDate.ToShortDateString()</div>
                            </div>
                        }
                        @if (clientPolicies != null)
                        {
                            <ul>
                                @foreach (var policy in clientPolicies)
                                {
                                    <li>@policy.PolicyNumber - @policy.eType - @policy.EffectiveDate - @policy.ExpirationDate</li>
                                }
                            </ul>
                        }
                    </div>
                </div>@* sf-col-1 *@

                <div class="sf-col sf-col-2">
                    <h3>Primary Contact</h3>
                    <strong>@selectedClient.PrimaryContact.FirstName @selectedClient.PrimaryContact.LastName</strong> <br />
                    @selectedClient.PrimaryContact.Phone<br />
                    <i>@selectedClient.PrimaryContact.Email</i><br />

                    <h4 class="sf-toppad">Additional Contacts</h4>
                    <ContactsListAll Contacts="@selectedClient.Contacts" ParentType="Client" ParentId="@selectedClient.ClientId" />
                    <h4 class="sf-toppad">Additional Info</h4>
                    @selectedClient.Website
                </div>@* sf-col-2 *@

                <div class="sf-col sf-col-3">
                    <h3>Technical Stuff</h3>
                    <p><strong>ID:</strong> @selectedClient.ClientId </p>
                    <p><strong>LookupCode:</strong> @selectedClient.LookupCode</p>
                    <p><strong>eClientId:</strong> @selectedClient.eClientId</p>
                    <p>
                        <strong>eClientId-New:</strong>
                        @if (isLoadingCrmId)
                        {
                            <span class="loading-spinner"></span> <!-- Add CSS for spinner -->
                        }
                        else if (string.IsNullOrEmpty(crmClientId))
                        {
                            <span>Loading...</span>
                        }
                        else
                        {
                            <span>@crmClientId</span>
                        }
                    </p>
                    <p><strong>Loading:</strong> @isLoadingCrmId.ToString()</p>
                    <p><strong>Server Status:</strong> @isLoadingWhat</p>
                </div>@* sf-col-3 *@

            </div>
        </div>
    }
    <div style="clear:both;"></div>
</div>

<style>
    .page-content {
        display: flex;
        flex-direction: row;
    }

    .tinyexpander {
        position: absolute;
        top: 0px;
        left: 0px;
        opacity: .3;
    }

        .tinyexpander:hover {
            opacity: 1;
            cursor: pointer;
        }

    :root .sf-quicklist {
        width: 300px !important;
        overflow: hidden;
        transition: all 0.5s ease;
    }

    :root .sf-quicklist-close {
        width: 1px !important;
        overflow: hidden;
        transition: all 0.5s ease;
    }

    :root .sf-quicklist .e-listview {
        padding: 0px !important;
        margin: 0px !important;
    }

    :root .e-listview .e-list-item {
        padding: 0px !important;
        margin: 0px !important;
        height: 25px !important;
    }

    :root .sf-collapse {
        width: 15px;
        background-color: #e2e2e2;
        height: 100%;
        float: right;
    }

    :root .sf-searchquick {
        width: 290px !important
    }
</style>

@code {
    [Parameter, SupplyParameterFromQuery]
    public int ClientId { get; set; } = 91;

    private string searchTerm = string.Empty;
    private List<Client> clients = new();
    private List<Client> filteredClients = new();
    private List<Policy> clientPolicies = new();
    private List<Policy> currentPolicies = new();
    private List<Policy> pastPolicies = new();

    private System.Timers.Timer debounceTimer;
    private bool isLoadingCrmId = false;
    private string crmClientId = string.Empty;
    private string isLoadingWhat = "Initializing";
    private string dynamicClass = "sf-quicklist";
    private Client selectedClient  { get; set; }

    SfTextBox SearchBox { get; set; }

    protected override async Task OnInitializedAsync()
    {
        debounceTimer = new System.Timers.Timer(100);
        debounceTimer.AutoReset = false;
        debounceTimer.Elapsed += (sender, args) => FilterClients();

        currentPolicies.Clear();
        pastPolicies.Clear();
        clientPolicies.Clear();
        selectedClient = await ClientService.GetClientById(ClientId);
        SortAndSeparatePolicies();

        clients = await Http.GetFromJsonAsync<List<Client>>("https://localhost:7074/api/Client");
        filteredClients = new List<Client>(clients);

        BreadcrumbService.UpdateBreadcrumb(new List<BreadcrumbItem>
        {
            new BreadcrumbItem { Text = "Home", Url = "/" },
            new BreadcrumbItem { Text = "Clients" }
        });
    }

    public void ExpandDetails()
    {
        if (dynamicClass == "sf-quicklist")
        {
            dynamicClass = "sf-quicklist-close";
        }
        else
        {
            dynamicClass = "sf-quicklist";
        }
    }

    private async void EditPolicy(int policyid)
    {
        Console.WriteLine("editing policy " + policyid);
        Navigation.NavigateTo($"/Policy/Edit/{policyid}");
    }

    private async Task CreateRenewal(int policyid)
    {
        Console.WriteLine("create renewal for " + policyid);
        var renewal = await RenewalService.CreateRenewalFromPolicy(policyid);
        int renewalid = renewal.RenewalId;
        Navigation.NavigateTo($"/Renewals/{renewalid}");
    }

    private void OnInputChanged(Microsoft.AspNetCore.Components.ChangeEventArgs e)
    {
        searchTerm = e.Value.ToString();
        debounceTimer.Stop();
        debounceTimer.Start();
    }

    private async void ClickHandler(ClickEventArgs<Client> args)
    {
        ClientId = filteredClients[args.Index].ClientId;
        selectedClient = await ClientService.GetClientById(ClientId);
        searchTerm = "";
        debounceTimer.Stop();
        debounceTimer.Start();

        //Get policies if we haven't fetched them from the API before
        if (selectedClient.eClientId == null)
        {
            isLoadingCrmId = true;
            isLoadingWhat += ".:";
            await LoadCrmClientIdAndPolicies(selectedClient.LookupCode, selectedClient.ClientId);
        }
            
        // Separate and sort policies
        NavigationService.SetLastClientPage("/Clients/List/" + ClientId);
        SortAndSeparatePolicies();
        
    }

    private async Task LoadCrmClientIdAndPolicies(string lookupCode, int clientid)
    {
        //API Call
        crmClientId = string.Empty;
        clientPolicies.Clear();
        try
        {
            isLoadingWhat += ".";
            var accessToken = await CrmApiService.GetAccessTokenAsync();
            var jsonResponse = await CrmApiService.GetClientDetailsAsync(lookupCode, accessToken);
            var clientData = JsonConvert.DeserializeObject<Dictionary<string, object>>(jsonResponse);
            isLoadingWhat += "$";
            if (clientData != null && clientData.ContainsKey("_embedded"))
            {
                var embeddedData = JsonConvert.DeserializeObject<Dictionary<string, object>>(clientData["_embedded"].ToString());
                if (embeddedData != null && embeddedData.ContainsKey("clients"))
                {
                    var clientsList = JsonConvert.DeserializeObject<List<Dictionary<string, object>>>(embeddedData["clients"].ToString());
                    if (clientsList != null && clientsList.Count > 0)
                    {
                        crmClientId = clientsList[0]["id"].ToString();
                        await LoadClientPolicies(crmClientId, accessToken);
                        isLoadingWhat += "%";
                    }
                }
            }

            //Update the database
            await ClientService.UpdateClientIdAndPolicies(selectedClient.ClientId, crmClientId, clientPolicies, accessToken);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error loading CRM client ID and policies: {ex.Message}");
        }
        finally
        {
            isLoadingCrmId = false;
            isLoadingWhat = "Done!";
            await InvokeAsync(StateHasChanged);
            NavigationManager.NavigateTo("Clients/List/" + clientid);
        }
    }

    private async Task LoadClientPolicies(string clientId, string accessToken)
    {
        try
        {
            var jsonResponse = await CrmApiService.GetClientPoliciesAsync(clientId, accessToken);
            isLoadingWhat += "^";
            var policyData = JsonConvert.DeserializeObject<JObject>(jsonResponse);

            if (policyData != null && policyData["_embedded"] != null)
            {
                var embeddedData = policyData["_embedded"] as JObject;
                if (embeddedData != null && embeddedData["policies"] != null)
                {
                    var policiesList = embeddedData["policies"].ToObject<List<JObject>>();
                    clientPolicies = policiesList.Select(p => new Policy
                        {
                            PolicyNumber = p["policyNumber"]?.ToString(),
                            ePolicyId = p["id"]?.ToString(),
                            eType = p["policyType"]?["description"]?.ToString(),
                            eTypeCode = p["policyType"]?["code"]?.ToString(),
                            Notes = p["description"]?.ToString(),
                            EffectiveDate = p["effectiveOn"] != null ? DateTime.Parse(p["effectiveOn"].ToString()) : DateTime.MinValue,
                            ExpirationDate = p["expirationOn"] != null ? DateTime.Parse(p["expirationOn"].ToString()) : DateTime.MinValue,
                            Premium = p["estimatedPremium"] != null ? decimal.Parse($"{p["estimatedPremium"]["units"]}.{p["estimatedPremium"]["partialUnits"]}") : 0m
                        }).ToList();
                }
            }
            SortAndSeparatePolicies();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error loading client policies: {ex.Message}");
        }
        finally
        {
            isLoadingWhat += "*";
            await InvokeAsync(StateHasChanged);
        }
    }

    private void SortAndSeparatePolicies()
    {
        var today = DateTime.Today;

        currentPolicies = selectedClient.Policies
            .Where(p => p.EffectiveDate <= today && p.ExpirationDate >= today)
            .OrderByDescending(p => p.EffectiveDate)
            .ToList();

        pastPolicies = selectedClient.Policies
            .Where(p => p.ExpirationDate < today)
            .OrderByDescending(p => p.EffectiveDate)
            .ToList();

        isLoadingWhat = "X";
        StateHasChanged();
    }

    private async Task FilterClients()
    {
        if (string.IsNullOrEmpty(searchTerm))
        {
            filteredClients = new List<Client>(clients);
        }
        else
        {
            filteredClients = clients
                .Where(client => client.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        debounceTimer?.Dispose();
    }
}
