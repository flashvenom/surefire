@page "/Renewals/{RenewalId:int}"
@using Mantis.Domain.Renewals.Models
@using Mantis.Domain.Renewals.ViewModels
@using Mantis.Domain.Renewals.Services
@using Microsoft.AspNetCore.Components
@using Syncfusion.Blazor
@using Syncfusion.Blazor.SplitButtons
@using Mantis.Domain.Shared.Helpers;
@inject RenewalService RenewalService

@rendermode InteractiveServer

<_toolbar />

<div class="page-content">
    @if (renewal != null)
    {
        <h1>@renewal.Client.Name - @renewal.RenewalId</h1>
       
        <table class="table">
            <thead>
                <tr>
                    <th></th>
                    <th style="width:280px">Task</th>
                    <th>Status</th>
                    <th style="width:400px">Notes</th>
                    <th>SubAssigned</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var task in Tasks)
                {
                    <tr class="@GetRowClass(task)">
                        <td>
                            <a id="myId-@(task.TaskItemId)" class="sf-threedot"><FluentIcon Value="@(new Icons.Regular.Size24.MoreVertical())" Color="Color.Accent" /></a>
                            <FluentMenu Anchor="@("myId-" + task.TaskItemId)" Trigger="MouseButton.Left" Anchored="true" VerticalInset="true">
                                <FluentMenuItem OnClick="@((e) => HighlightRow(task.TaskItemId))">
                                    <span slot="start"><FluentIcon Value="@(new Icons.Regular.Size24.Lightbulb())" Color="Color.FillInverse" Slot="start" /></span>
                                    Highlight
                                </FluentMenuItem>
                                <FluentMenuItem OnClick="@((e) => EditRow(task.TaskItemId))">
                                    <span slot="start"><FluentIcon Value="@(new Icons.Regular.Size24.PenSparkle())" Color="Color.FillInverse" Slot="start" /></span>
                                    Edit
                                </FluentMenuItem>

                            </FluentMenu>
                            <input type="checkbox" class="sf-completedcheckbox" checked="@task.IsCompleted" @onchange="@(args => OnCompletedChanged(task.TaskItemId, ((Microsoft.AspNetCore.Components.ChangeEventArgs)args).Value))" />
                        </td>
                        <td style="padding:0px 5px;">@task.TaskItemName</td>
                        <td class="ds">@((MarkupString)DateHelper.FormatRenewalStatus(task.TaskGoalDate, task.IsCompleted, task.TaskCompletedDate))</td>
                        <td>
                            <input type="text" value="@task.Notes" class="e-input" />
                        </td>
                        <td>@(task.AssignedSubUser?.Email ?? "")</td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <h1>Loading renewal...</h1>
    }
</div>

<style>
    .highlighted-row td:nth-child(2) {
        background-color: #ffe762ff !important;
        color: #000000be !important;
    }

    :root .e-input {
        padding: 5px; /* Adjust the padding as needed */
        height:20px !important;
        font-size: 12px !important; /* Adjust the font size as needed */
    }
    .sf-threedot {
        opacity:.3;
    }

    .sf-threedot:hover {
        opacity: 1;
    }

    .completed-row > td:not(:first-child) {
        opacity: .5 !important;
    }

    .db {
        font-size: 13px;
        font-weight: bold;
    }
</style>

@code {
    [Parameter]
    public int RenewalId { get; set; }

    private Renewal renewal;
    private List<TaskItemViewModel> Tasks;

    protected override async Task OnInitializedAsync()
    {
        renewal = await RenewalService.GetRenewalByIdAsync(RenewalId);
        Tasks = await RenewalService.GetTasksForRenewalAsync(RenewalId);
        BreadcrumbService.UpdateBreadcrumb(new List<BreadcrumbItem>
        {
            new BreadcrumbItem { Text = "Home", Url = "/" },
            new BreadcrumbItem { Text = "Renewals", Url = "/Renewals" },
            new BreadcrumbItem { Text = "Editing #" + RenewalId }
        });
    }

    private async void EditRow(int taskid)
    {
        Console.WriteLine("editing row " + taskid);
        Navigation.NavigateTo($"/Renewals/EditTrackTask/{taskid}");
    }

    private async void HighlightRow(int taskid)
    {
        Console.WriteLine("Highlighting row " + taskid);
        var task = Tasks.FirstOrDefault(t => t.TaskItemId == taskid);
        if (task != null)
        {
            task.IsHighlighted = !task.IsHighlighted;
            await RenewalService.UpdateTaskHighlight(taskid, task.IsHighlighted);
            StateHasChanged();
        }
    }

    private async void OnCompletedChanged(int taskItemId, object isChecked)
    {
        var task = Tasks.FirstOrDefault(t => t.TaskItemId == taskItemId);
        if (task != null)
        {
            task.IsCompleted = (bool)isChecked;
            await RenewalService.UpdateTaskCompleted(taskItemId, task.IsCompleted);
            StateHasChanged();
        }
    }
    private async void OnNotesChanged(int taskItemId, string newNotes)
    {
        var task = Tasks.FirstOrDefault(t => t.TaskItemId == taskItemId);
        if (task != null)
        {
            task.Notes = newNotes;
            // Call your save method here, e.g., _taskService.SaveNotes(taskItemId, newNotes);
        }
    }


    private string GetRowClass(TaskItemViewModel task)
    {
        var classes = new List<string>();
        if (task.IsHighlighted)
        {
            classes.Add("highlighted-row");
        }
        if (task.IsCompleted)
        {
            classes.Add("completed-row");
        }
        return string.Join(" ", classes);
    }
}
